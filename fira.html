<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FIRA</title>
	<link rel="icon" href="data:;base64,iVBORw0KGgo=">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<style type="text/css">
		body {
			background-color: #d0cccc;
			padding: 1em 1em 0em 1em;
		}
		.glyphicon.spinning {
			animation: spin 1s infinite linear;
		}
		@keyframes spin {
			from { transform: scale(1) rotate(0deg);}
			to { transform: scale(1) rotate(360deg);}
		}
		a {
			cursor: pointer;
		}
		.logo {
			position: relative;
			top: 0.2em;
			font-size: 2em;
			font-style: italic;
			font-weight: bold;
			padding-right: 0.5em;
		}
		.col-sm-3 {
			padding-left: 0.5em;
			padding-right: 0.5em;
		}
		.form-inline label {
			padding-right: 0.5em;
		}
		.issue-list .panel {
			margin-bottom: 0.7em;
		}
		.issue-list .panel-heading {
			background-color: #dedfe8;
			cursor: move;
			padding: 0.1em 0.5em 0.1em 0.5em;
		}
		.issue-list .panel-heading:hover {
			background-color: #ced1f3;
		}
		.issue-list .panel-title {
			font-size: 0.8em;
			font-weight: bold;
		}
		.issue-list .panel-body {
			padding: 0.4em 0.5em 0.4em 0.5em;
		}
		.issue-list .panel-body:hover {
			background-color: #EEE;
		}
		.issue-list .panel-heading .glyphicon {
			padding-left: 0.5em;
			color: #AAA;
		}
		.issue-list .panel-heading .glyphicon:hover {
			color: #0A0;
			cursor: pointer;
		}
		.hidden-placeholder {
			min-height: 50px;
		}
		.ui-sortable-placeholder {
			border: 2px dotted #D0D0D0;
			background-color: #999;
			visibility:visible !important;
		}
		.ui-sortable-helper {
			opacity: 0.7;
			transform: rotate(4deg);
		}
	</style>
	<script>
		// Inspired by hyperscript, with no dependencies and a bit simpler
		function z() {
			var a = arguments[0];
			var m = a.split( /(?=[\.#])/g );
			var e = document.createElement( m[0] );
			m.slice(1).forEach( function (i) {
				var term = i.substring(1);
				if( i[0] === '.' ) {
					e.className += ' ' + term;
				}
				else if( i[0] === '#' ) {
					e.setAttribute( 'id', term );
				}
			});
			for( var i=1; i<arguments.length; i++ ) {
				var a = arguments[i];
				if( typeof a === 'string' ) {
					e.appendChild( document.createTextNode(a) );
				}
				else if( a instanceof Array ) {
					for( var j=0; j<a.length; j++ ) {
						if( typeof a[j] !== 'undefined' ) {
							e.appendChild( a[j] );
						}
					}
				}
				else if( a instanceof HTMLElement ) {
					e.appendChild( a );
				}
				else if( a instanceof Object ) {
					for( var key in a ) {
						if( a.hasOwnProperty(key) ) {
							if( key == 'data' ) {
								for( var d in a[key] ) {
									e.dataset[a[key][d].key] = a[key][d].val;
								}
							}
							else {
								e.setAttribute( key, a[key] );
							}
						}
					}
				}
			}
			return e;
		}

		function setCookie(name, value) {
			document.cookie = name + '=' + encodeURIComponent(value) + '; expires=2147483647; path=/';
		}

		function getCookie(name) {
			return document.cookie.split('; ').reduce( (r, v) => {
				const parts = v.split('=');
				return parts[0] === name ? decodeURIComponent(parts[1]) : r;
			}, '');
		}
	</script>
	<script>
		let softwareGroup = [
			'zack',
			'youssef',
			'willy',
			'pablo',
			'mike mccabe',
			'kyle heath',
			'guy',
			'davidrideout',
			'daniel ford',
		];

		let projects = {};

		let jiraStatusToFiraCol = {
			'New': 'New',
			'To Do': 'To Do',
			'In Progress': 'In Progress',
			'Completed: needs review': 'In Review',
			'Accepted': 'In Review',
			'Planned': 'Planned',
			'Done': 'Done',
			"Won't Fix": 'Done',
		}

		let firaColToJiraStatus = {
			'New': 'New',
			'To Do': 'To Do',
			'In Progress': 'In Progress',
			'In Review': 'Completed: needs review',
			'Planned': 'Planned',
			'Done': 'Done',
		}

		let firaPlannedColToPriority = {
			'Planned Low': 'Low',
			'Planned Med': 'Medium',
			'Planned High': 'High',
		}

		let issuesByKey = {};

		function jira(method, path, params, body, success) {
			$.ajax({
				method: method,
				contentType: 'application/json',
				dataType: 'json',
				url: 'http://localhost:8080' + path + (params ? '?' + $.param(params) : ''),
				data: body ? JSON.stringify(body) : null,
				success: success,
				error: (jqXHR, textStatus, errorThrown) => {
					alert(
						'Communication with JIRA failed.\n\nPerhaps your JIRA key is mis-configured on the Configure option?\n\n' +
						'Exact message is: ' + textStatus + ' ' + errorThrown
					);
				}
			});
		}

		function jiraCreateIssue(fields) {
			let project = projects.find( i => i.name === fields.project );
			let postBody = {
				fields: {
					project: {
						id: project.id
					},
					summary: fields.summary,
					description: fields.description,
					assignee: {
						name: fields.assignee
					},
					issuetype: {
						id: 3 // Chore
					}
				}
			}
			jira('POST', '/rest/api/2/issue', null, postBody);
		}

		function jiraUpdateIssue(key, fields) {
			let putBody = {
				fields: {
					summary: fields.summary,
					description: fields.description,
					assignee: {
						name: fields.assignee
					},
				}
			}
			if( fields.new_comment ) {
				putBody['update'] = {
					comment: [{
						add: {
							body: fields.new_comment
						}
					}]
				}
			}
			jira('PUT', '/rest/api/2/issue/'+key, null, putBody);
		}

		function jiraTransition(key, toCol) {
			jira('GET', '/rest/api/2/issue/'+key+'/transitions', null, null, (transitions)=>{
				let toPlanned = toCol.split(' ')[0] == 'Planned';

				let jiraStatus;
				if( toPlanned ) {
					jiraStatus = 'Planned';
				}
				else {
					jiraStatus = firaColToJiraStatus[toCol];
				}
				transition = {
					transition: {
						id: transitions.transitions.find(t => t.to.name === jiraStatus).id
					}
				}
				jira('POST', '/rest/api/2/issue/'+key+'/transitions', null, transition);

				let actions = [];
				if( toPlanned ) {
					newPriority = firaPlannedColToPriority[toCol];
					let putBody = {
						update: {
							priority: [{
								set: {
									name: newPriority
								}
							}]
						}
					}

					jira('PUT', '/rest/api/2/issue/'+key, null, putBody);
				}
			});
		}

		function jiraToFiraIssue(issue) {
			let col = jiraStatusToFiraCol[issue.fields.status.name];
			if( col == 'Planned' ) {
				col = 'Planned Low';
				if( issue.fields.priority.name === 'High' ) {
					col = 'Planned High';
				}
				else if( issue.fields.priority.name === 'Medium' ) {
					col = 'Planned Med';
				}
			}
			return {
				key: issue.key,
				summary: issue.fields.summary,
				description: issue.fields.description,
				col: col,
				sort: issue.fields.customfield_10012,
				resolutiondate: issue.fields.resolutiondate,
				assignee: issue.fields.assignee.key,
				comments: issue.fields.comment.comments,
				jiraIssue: issue
			};
		}

		function jiraSearch(assignee, onDone) {
			let body = {
				jql: 'assignee="'+assignee+'" AND (status not in (done) OR resolutiondate > -7d)',
				startAt: 0,
				maxResults: 100000000,
				fields: [
					'summary',
					'status',
					'assignee',
					'creator',
					'issuetype',
					'reporter',
					'description',
					'labels',
					'customfield_10012',
					'priority',
					'resolutiondate',
					'comment',
				],
				fieldsByKeys: false
			}
			jira('POST', '/rest/api/2/search', null, body, (data)=>{
				// let issues = data.issues.filter(i => i.fields.issuetype.name !== 'Epic' && i.fields.issuetype.name !== 'Story');
				let issues = data.issues;
				let myIssues = issues.map((i) => {
					return jiraToFiraIssue(i);
				});
				issuesByKey = myIssues.reduce( (map, i) => {
					map[i.key] = i;
					return map;
				}, {});
				onDone(myIssues);
			});
		}

		function renderIssue(issue) {
			let hideDone = issue.resolutiondate === null ? '' : '.hidden';
			let hidePromote = ['In Review', 'Done', 'Planned High'].includes(issue.col) ? '.hidden' : '';
			let hideDemote = ['Done', 'New', 'Planned Low'].includes(issue.col) ? '.hidden' : '';
			let hidePlan = ['New'].includes(issue.col) ? '' : '.hidden';
			let hideTodo = ['Planned Low', 'Planned Med', 'Planned High'].includes(issue.col) ? '' : '.hidden';
			return z('li.panel.panel-default', {'data-key': issue.key},
				z('div.panel-heading',
					z('div.panel-title', issue.key,
						z('span.glyphicon.glyphicon-ok.pull-right.close-issue'+hideDone, {'aria-hidden':true}),
						z('span.glyphicon.glyphicon-arrow-right.pull-right.promote-issue'+hidePromote, {'aria-hidden':true}),
						z('span.glyphicon.glyphicon-arrow-left.pull-right.demote-issue'+hideDemote, {'aria-hidden':true}),
						z('span.glyphicon.glyphicon-arrow-down.pull-right.plan-issue'+hidePlan, {'aria-hidden':true}),
						z('span.glyphicon.glyphicon-arrow-up.pull-right.todo-issue'+hideTodo, {'aria-hidden':true}),
					)
				),
				z('div.panel-body', issue.summary)
			);
		}

		function renderCol(col, colLabel, issues) {
			return z('div',
				z('h4', colLabel),
				z('ul.issue-list.list-unstyled', {'data-col': col},
					issues.sort( (a, b)=> {
						return a.sort > b.sort ? 1 : (a.sort < b.sort ? -1 : 0);
					}).map( i => renderIssue(i) ),
					z('div.hidden-placeholder')
				)
			);
		}

		function renderIssues(issues) {
			let topCols = ['New', 'To Do', 'In Progress', 'In Review'];
			let botCols = ['Planned Low', 'Planned Med', 'Planned High', 'Done'];
			let zz = z('div.issues',
				z('div.row',
					topCols.map( (col) => {
						let issuesForCol = issues.filter( (i) => { return i.col === col } );
						return z('div.col-sm-3',
							renderCol(col, col, issuesForCol)
						);
					})
				),
				z('div.row', 
					botCols.map( (col) => {
						let showTime = 1000 * 60 * 60 * 24 * 7; // One week
						let issuesForCol = issues.filter( (i) => { return i.col === col } );
						let colLabel = col;
						if( col == 'Done' ) {
							colLabel = 'Done (recent)'
							issuesForCol = issuesForCol.filter( (i) => {
								let a = Date.parse(i.resolutiondate);
								let b = (new Date).getTime();
								return a && b && b-a < showTime;
							});
						}
						return z('div.col-sm-3',
							renderCol(col, colLabel, issuesForCol)
						);
					})
				)
			);
			$('#issues-section').html( zz );

			let issueList = $('.issue-list');
			issueList.sortable({
				handle: '.panel-heading', 
				connectWith: '.issue-list',
				update: (event, ui) => {
					if( ui.sender ) {
						let key = $(ui.item).data('key');
						let toCol = $(event.target).data('col');
						let fromCol = $(ui.sender).data('col');
						jiraTransition(key, toCol);
					}
				}
			});

			$('.close-issue').click( function() {
				let $panel = $(this).parents('.panel')
				let key = $panel.data('key');
				jiraTransition(key, 'Done');
				$panel.fadeOut( 300, () => {
            		let $done = $(".issue-list[data-col='Done']");
            		$panel.prependTo($done);
            		$panel.removeAttr('style');
        		});
			});
		}

		function listAsOptions(list) {
			return list.sort().map( i => z('option', i) );
		}

		function createConfigureForm() {
			let jiraCookie = getCookie('jiracookie');
			let zz = z('div',
				z('div.form-group',
					z('label', {for:'jiracookie'}, 'JIRA cookies. (Paste from your JIRA tab, should start with _csrf=)'),
					z('textarea.form-control', {name:'jiracookie', rows:15})
				)
			);
			$('textarea[name=jiracookie]', zz).val( jiraCookie );
			return zz;
		}

		function createIssueForm(issue, isNew) {
			let zz = z('div',
				z('div.form-group',
					z('label', {for:'summary'}, 'Summary'),
					z('input.form-control', {name:'summary'})
				),
				z('div.form-group',
					z('label', {for:'description'}, 'Description'),
					z('textarea.form-control', {name:'description', rows:4})
				),
				z('div.form-group',
					z('label', {for:'assignee'}, 'Assignee'),
					z('select.form-control', {name:'assignee'},
						listAsOptions(softwareGroup)
					)
				)
			);

			if( isNew ) {
				let projectNames = projects.map( p => p.name );
				let project = z('div.form-group',
					z('label', {for:'project'}, 'Project'),
					z('select.form-control#last-project', {name:'project'},
						listAsOptions(projectNames)
					)
				);
				$(zz).append( project );
				$('#last-project', zz).val( getCookie('lastProject') );
			}

			let issueFields = ['summary', 'description', 'assignee'];
			issueFields.map( (field) => {
				$('.form-control[name='+field+']', zz).val( issue[field] );
			});

			if( ! isNew ) {
				let comments = z('div.panel.panel-default',
					z('div.panel-heading', 'Comments'),
					z('ul.list-group',
						issue.comments.map( (c) => {
							return z('li.list-group-item', 
								z('strong', c.author.name),
								z('span', ': ' + c.body)
							);
						})
					)
				);
				$('.list-group', comments).append(
					z('li.list-group-item',
						z('input#new-comment.form-control', {name:'new_comment', type:'text', placeholder:'New comment'})
					)
				);
				$(zz).append( comments );
			}

			return zz;
		}

		function createDialog(title, formBody, onSave) {
			let dialogFormId = 'form-'+Date.now();
			let zz = z('div.modal.fade', {role:'dialog'},
				z('div.modal-dialog.modal-lg',
					z('div.modal-content',
						z('div.modal-header',
							z('button.close', {'data-dismiss':'modal'}, 'x'),
							z('h4.modal-title', title)
						),
						z('form', {role:'form', id:dialogFormId},
							z('div.modal-body',
								formBody
							),
							// z('button.btn.btn-primary', {type:'submit', value:'submit'}, 'Save test')
						),
						z('div.modal-footer',
							z('button.btn.btn-default', {'data-dismiss':'modal'}, 'Cancel'),
							z('button.btn.btn-primary', {type:'submit', form:dialogFormId}, 'Save')
						)
					)
				)
			);

			$('body').append(zz);

			$(zz).modal();

			$('form', zz).submit( () => {
				let fields = {};
				$('form :input', zz).each( function() {
					fields[$(this).attr('name')] = $(this).val();
				});
				onSave(fields);
				$(zz).modal('hide');
				return false;
			});

			$(zz).on( 'hidden.bs.modal', () => {
				$(zz).remove();
			});

			return zz;
		}

		function reload() {
			let assignee = $('#filter-assignee').val()
			let waiting = z('h3.text-center',
				z('span.glyphicon.glyphicon-refresh.spinning'),
				z('span', ' Loading...')
			);
			$('#issues-section').html(waiting);
			jiraSearch( assignee, (issues) => {
				renderIssues(issues);
			});
		}

		function getAllUsers() {
			// For reference, not currently used.
			jira('GET', '/rest/api/latest/user/search', {startAt:0, maxResults:1000, username:'%'}, null, (data)=>{
				let users = data.map( (i) => {
					if( i.active ) {
						return i.key;
					}
				});
			});
		}

		function getAllProjects() {
			jira('GET', '/rest/api/2/project', {startAt:0, maxResults:1000}, null, (data)=>{
				projects = data.map( (p) => {
					return {
						id: p.id,
						name: p.name,
					}
				});
			});
		}

		$(document).ready(function() {
			// jira('GET', '/rest/api/2/issue/SI-300', null, null, (data)=>{
			// 	debugger;
			// });

			getAllProjects();

			let topBar = z('form.form-inline',
				z('span.logo', 'F*IRA'),
				z('div.form-group',
					z('label', {for:'filter-assignee'}, 'Filter for assignee:'),
					z('select.form-control#filter-assignee')
				),
				z('div.pull-right',
					z('button.btn.btn-link#btn-configure', 'Configure'),
					z('button.btn.btn-success#btn-new-issue', 'New issue'),
				)
			);
			$('#nav-section').html(topBar);

			$('#filter-assignee').html( listAsOptions(softwareGroup) );

			$('#filter-assignee').val( getCookie('filter-assignee') );

			$('#filter-assignee').change( function() {
				setCookie('filter-assignee', $(this).val() );
				reload();
			});

			$('#btn-new-issue').click( () => {
				let newIssue = { assignee: $('#filter-assignee').val() }
				createDialog( 'New Issue', createIssueForm(newIssue, true), (fields) => {
					setCookie( 'lastProject', fields.project );
					jiraCreateIssue( fields );
					reload();
				});
				return false;
			});

			$('#btn-configure').click( () => {
				createDialog( 'Configure', createConfigureForm(), (fields) => {
					setCookie('jiracookie', fields.jiracookie);
					reload();
				});
				return false;
			})

			reload();

			$(document).on( 'click', '.panel-body', (e) => {
				let key = $(e.target).parents('.panel').data('key');
				let origIssue = issuesByKey[key];
				createDialog( 'Edit Issue ' + key, createIssueForm(origIssue, false), (fields) => {
					jiraUpdateIssue(key, fields);
					if( fields.assignee !== origIssue.assignee || fields.new_comment !== '' ) {
						reload();
					}
					else {
						let newIssue = issuesByKey[key];
						newIssue = Object.assign(newIssue, fields);
						$('.panel[data-key='+key+']').replaceWith( renderIssue(newIssue) );
					}
				});
			});
		});
	</script>
</head>
<body>
	<div id="nav-section" class="container-fluid">
	</div>
	<div id="issues-section" class="container-fluid">
	</div>
	<!--
	<h3>TODO</h3>
	<ul>
		<li>Implement transition shortcuts</li>
		<li>Save sort order</li>
		<li>Epic tags</li>
	</ul>
	-->
</body>
</html>
