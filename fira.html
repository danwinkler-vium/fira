<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FIRA</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<script src="z.js"></script>
	<style type="text/css">
		body {
			background-color: #d0cccc;
			padding-left: 1em;
			padding-right: 1em;
		}
		.col-sm-3 {
			padding-left: 0.5em;
			padding-right: 0.5em;
		}
		.issue-list .panel {
			margin-bottom: 0.7em;
		}
		.issue-list .panel-heading {
			background-color: #dedfe8;
			cursor: move;
			padding: 0.1em 0.5em 0.1em 0.5em;
		}
		.issue-list .panel-heading:hover {
			background-color: #ced1f3;
		}
		.issue-list .panel-title {
			font-size: 0.8em;
			font-weight: bold;
		}
		.issue-list .panel-body {
			padding: 0.4em 0.5em 0.4em 0.5em;
		}
		.issue-list .panel-body:hover {
			background-color: #EEE;
		}
		.issue-list .panel-heading .glyphicon {
			color: #AAA;
		}
		.issue-list .panel-heading .glyphicon:hover {
			color: #0A0;
			cursor: pointer;
		}
		.hidden-placeholder {
			min-height: 50px;
		}
		.ui-sortable-placeholder {
			border: 2px dotted #D0D0D0;
			background-color: #999;
			visibility:visible !important;
		}
		.ui-sortable-helper {
			opacity: 0.7;
			transform: rotate(4deg);
		}
	</style>
	<script>
		let jiraStatusToFiraCol = {
			'New': 'New',
			'To Do': 'To Do',
			'In Progress': 'In Progress',
			'Completed: needs review': 'In Review',
			'Accepted': 'In Review',
			'Planned': 'Planned',
			'Done': 'Done',
			"Won't Fix": 'Done',
		}

		let firaColToJiraStatus = {
			'New': 'New',
			'To Do': 'To Do',
			'In Progress': 'In Progress',
			'In Review': 'Completed: needs review',
			'Planned': 'Planned',
			'Done': 'Done',
		}

		let firaPlannedColToPriority = {
			'Planned Low': 'Low',
			'Planned Med': 'Medium',
			'Planned High': 'High',
		}

		let issuesByKey = {};

		function jira(method, path, params, body, success) {
			$.ajax({
				method: method,
				contentType: 'application/json',
				dataType: 'json',
				url: 'http://localhost:8080' + path + (params ? '?' + $.param(params) : ''),
				data: JSON.stringify(body),
				success: success,
				error: () => {
					console.log('error on jira');
				},
			});
		}

		function jiraTransition(key, toCol) {
			jira('GET', '/rest/api/2/issue/'+key+'/transitions', null, null, (transitions)=>{
				let toPlanned = toCol.split(' ')[0] == 'Planned';

				let jiraStatus;
				if( toPlanned ) {
					jiraStatus = 'Planned';
				}
				else {
					jiraStatus = firaColToJiraStatus[toCol];
				}
				transition = {
					transition: {
						id: transitions.transitions.find(t => t.to.name === jiraStatus).id
					}
				}
				jira('POST', '/rest/api/2/issue/'+key+'/transitions', null, transition);

				let actions = [];
				if( toPlanned ) {
					newPriority = firaPlannedColToPriority[toCol];
					let putBody = {
						update: {
							priority: [{
								set: {
									name: newPriority
								}
							}]
						}
					}

					jira('PUT', '/rest/api/2/issue/'+key, null, putBody);
				}
			});
		}

		function jiraSearchIssues() {
			let body = {
				jql: 'assignee=zack',
				startAt: 0,
				maxResults: 100000000,
				fields: [
					'summary',
					'status',
					'assignee',
					'creator',
					'issuetype',
					'reporter',
					'description',
					'labels',
					'customfield_10012',
					'priority',
					'resolutiondate',
					'comments',
				],
				fieldsByKeys: false
			}
			jira('POST', '/rest/api/2/search', null, body, (data)=>{
				let issues = data.issues.filter(i => i.fields.issuetype.name !== 'Epic' && i.fields.issuetype.name !== 'Story');
				let myIssues = issues.map((i) => {
					let col = jiraStatusToFiraCol[i.fields.status.name];
					if( col == 'Planned' ) {
						col = 'Planned Low';
						if( i.fields.priority.name === 'High' ) {
							col = 'Planned High';
						}
						else if( i.fields.priority.name === 'Medium' ) {
							col = 'Planned Med';
						}
					}
					return {
						key: i.key,
						summary: i.fields.summary,
						description: i.fields.description,
						col: col,
						sort: i.fields.customfield_10012,
						resolutiondate: i.fields.resolutiondate,
					};
				});
				issuesByKey = myIssues.reduce( (map, i) => {
					map[i.key] = i;
					return map;
				});
				renderIssues(myIssues);
			});
		}

		function renderCol(col, issues) {
			return z('div',
				z('h4', col),
				z('ul.issue-list.list-unstyled', {'data-col': col},
					issues.sort( (a, b)=> {
						return a.sort > b.sort ? 1 : (a.sort < b.sort ? -1 : 0);
					}).map( (i) => {
						return z('li.panel.panel-default', {'data-key': i.key},
							z('div.panel-heading',
								z('div.panel-title', i.key,
									z('span.glyphicon.glyphicon-ok.pull-right.close-issue', {'aria-hidden':true})
								)
							),
							z('div.panel-body', i.summary)
						);
					}),
					z('div.hidden-placeholder')
				)
			);
		}

		function renderIssues(issues) {
			let topCols = ['New', 'To Do', 'In Progress', 'In Review'];
			let botCols = ['Planned High', 'Planned Med', 'Planned Low', 'Done'];
			let zz = z('div',
				z('div.row',
					topCols.map( (col) => {
						let issuesForCol = issues.filter( (i) => { return i.col === col } );
						return z('div.col-sm-3',
							renderCol(col, issuesForCol)
						);
					})
				),
				z('div.row', 
					botCols.map( (col) => {
						let showTime = 1000 * 60 * 60 * 24 * 7; // One week
						let issuesForCol = issues.filter( (i) => { return i.col === col } );
						if( col == 'Done' ) {
							issuesForCol = issuesForCol.filter( (i) => {
								let a = Date.parse(i.resolutiondate);
								let b = (new Date).getTime();
								return a && b && b-a < showTime;
							});
						}
						return z('div.col-sm-3',
							renderCol(col, issuesForCol)
						);
					})
				)
			);
			$('body').append( zz );

			let issueList = $('.issue-list');
			issueList.sortable({
				handle: '.panel-heading', 
				connectWith: '.issue-list',
				update: (event, ui) => {
					if( ui.sender ) {
						let key = $(ui.item).data('key');
						let toCol = $(event.target).data('col');
						let fromCol = $(ui.sender).data('col');
						jiraTransition(key, toCol);
					}
				}
			});

			$('.close-issue').click( function() {
				let $panel = $(this).parents('.panel')
				let key = $panel.data('key');
				jiraTransition(key, 'Done');
				$panel.fadeOut( 300, () => {
            		let $done = $(".issue-list[data-col='Done']");
            		$panel.prependTo($done);
            		$panel.removeAttr('style');
        		});
			});
		}

		function editIssue(issue) {
			$('#issue-edit-modal').dialog('open');
		}

		function createEditorDialog() {
			let zz = z('div#editor.modal.fade', {role:'dialog'},
				z('div.modal-dialog.modal-lg',
					z('div.modal-content',
						z('div.modal-header',
							z('button.close', {'data-dismiss':'modal'}, 'x'),
							z('h4.modal-title', 'Edit')
						),
						z('form', {role:'form'},
							z('div.modal-body',
								z('div.form-group',
									z('label', {for:'summary'}, 'Summary'),
									z('input.form-control', {name:'summary'})
								),
								z('div.form-group',
									z('label', {for:'description'}, 'Description'),
									z('textarea.form-control', {name:'description', rows:4})
								)
							),
							z('div.modal-footer',
								z('button.btn.btn-primary', {type:'submit', 'data-dismiss':'modal'}, 'Close')
							)
						)
					)
				)
			);
			$('body').append(zz);
		}

		function createTopBar() {
			let zz = z('div',
				z('button.btn.btn-success#btn-new-issue', 'New issue'),
				z('button.btn.btn-link#btn-configure', 'Configure')
			);
			$('body').append(zz);
			$('#btn-new-issue').click( () => {
				
			});
		}

		$(document).ready(function() {
			// jira('GET', '/rest/api/2/issue/SI-300', null, null, (data)=>{
			// 	console.log('SI-300', data);
			// });

			createTopBar();
			createEditorDialog();
			jiraSearchIssues();

			$(document).on( 'click', '.panel-body', (e) => {
				let key = $(e.target).parents('.panel').data('key');
				let issue = issuesByKey[key];
				let fields = ['summary', 'description'];
				fields.map( (field) => {
					$('#editor .form-control[name='+field+']').val(issue[field]);
				});
				$('#editor .modal-title').text(key);
				$('#editor').modal();
			});
		});
	</script>
</head>
<body>
	<ul>
		<li>New/Edit save, new button</li>
		<li>Comments</li>
		<li>Client side cookie</li>
		<li>Convert dialogs to z</li>
		<li>Save my sort order in a label or custom field</li>
		<li>Switch assignee view</li>
		<li>Epic tags</li>
		<li>Loading spinner</li>
	</ul>
</body>
</html>
